<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xmlns:flowable="http://flowable.org/bpmn"
             xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
             xmlns:omgdc="http://www.omg.org/spec/DD/20100524/DC"
             xmlns:omgdi="http://www.omg.org/spec/DD/20100524/DI"
             typeLanguage="http://www.w3.org/2001/XMLSchema"
             expressionLanguage="http://www.w3.org/1999/XPath"
             targetNamespace="http://www.flowable.org/processdef">

    <process id="threeStageProcess" name="Three Stage Approval Process (Products-Plans-Items)" isExecutable="true">
        
        <!-- Start Event -->
        <startEvent id="startEvent" name="Start"/>
        <sequenceFlow id="flow1" sourceRef="startEvent" targetRef="stage1MakerTask"/>
        
        <!-- STAGE 1: Products (Maker) -->
        <userTask id="stage1MakerTask" name="Stage 1: Maker Edit Products" 
                  flowable:formKey="/maker/product-edit" 
                  flowable:candidateGroups="MAKER">
            <extensionElements>
                <flowable:taskListener event="complete" 
                                       delegateExpression="${productTaskListener}"/>
            </extensionElements>
        </userTask>
        <sequenceFlow id="flow2" sourceRef="stage1MakerTask" targetRef="stage1CheckerTask"/>
        
        <!-- STAGE 1: Products (Checker) -->
        <userTask id="stage1CheckerTask" name="Stage 1: Checker Approve Products" 
                  flowable:formKey="/checker/product-approval" 
                  flowable:candidateGroups="CHECKER"/>
        <sequenceFlow id="flow3" sourceRef="stage1CheckerTask" targetRef="stage1Gateway"/>
        
        <!-- STAGE 1: Gateway -->
        <exclusiveGateway id="stage1Gateway" name="Products Approved?"/>
        <sequenceFlow id="flow4" name="Approved" sourceRef="stage1Gateway" targetRef="stage2MakerTask">
            <conditionExpression xsi:type="tFormalExpression">
                ${stage1Decision == 'APPROVE'}
            </conditionExpression>
        </sequenceFlow>
        <sequenceFlow id="flow5" name="Rejected" sourceRef="stage1Gateway" targetRef="endEventRejected">
            <conditionExpression xsi:type="tFormalExpression">
                ${stage1Decision == 'REJECT'}
            </conditionExpression>
        </sequenceFlow>
        
        <!-- STAGE 2: Plans (Maker) -->
        <userTask id="stage2MakerTask" name="Stage 2: Maker Edit Plans" 
                  flowable:formKey="/maker/plan-edit" 
                  flowable:candidateGroups="MAKER">
            <extensionElements>
                <flowable:taskListener event="complete" 
                                       delegateExpression="${planTaskListener}"/>
            </extensionElements>
        </userTask>
        <sequenceFlow id="flow6" sourceRef="stage2MakerTask" targetRef="stage2CheckerTask"/>
        
        <!-- STAGE 2: Plans (Checker) -->
        <userTask id="stage2CheckerTask" name="Stage 2: Checker Approve Plans" 
                  flowable:formKey="/checker/plan-approval" 
                  flowable:candidateGroups="CHECKER"/>
        <sequenceFlow id="flow7" sourceRef="stage2CheckerTask" targetRef="stage2Gateway"/>
        
        <!-- STAGE 2: Gateway -->
        <exclusiveGateway id="stage2Gateway" name="Plans Approved?"/>
        <sequenceFlow id="flow8" name="Approved" sourceRef="stage2Gateway" targetRef="stage3MakerTask">
            <conditionExpression xsi:type="tFormalExpression">
                ${stage2Decision == 'APPROVE'}
            </conditionExpression>
        </sequenceFlow>
        <sequenceFlow id="flow9" name="Rejected" sourceRef="stage2Gateway" targetRef="endEventRejected">
            <conditionExpression xsi:type="tFormalExpression">
                ${stage2Decision == 'REJECT'}
            </conditionExpression>
        </sequenceFlow>
        
        <!-- STAGE 3: Items (Maker) -->
        <userTask id="stage3MakerTask" name="Stage 3: Maker Edit Items" 
                  flowable:formKey="/maker/item-edit" 
                  flowable:candidateGroups="MAKER">
            <extensionElements>
                <flowable:taskListener event="complete" 
                                       delegateExpression="${itemTaskListener}"/>
            </extensionElements>
        </userTask>
        <sequenceFlow id="flow10" sourceRef="stage3MakerTask" targetRef="stage3CheckerTask"/>
        
        <!-- STAGE 3: Items (Checker) -->
        <userTask id="stage3CheckerTask" name="Stage 3: Checker Approve Items" 
                  flowable:formKey="/checker/item-approval" 
                  flowable:candidateGroups="CHECKER"/>
        <sequenceFlow id="flow11" sourceRef="stage3CheckerTask" targetRef="stage3Gateway"/>
        
        <!-- STAGE 3: Gateway -->
        <exclusiveGateway id="stage3Gateway" name="Items Approved?"/>
        <sequenceFlow id="flow12" name="Approved" sourceRef="stage3Gateway" targetRef="endEventApproved">
            <conditionExpression xsi:type="tFormalExpression">
                ${stage3Decision == 'APPROVE'}
            </conditionExpression>
        </sequenceFlow>
        <sequenceFlow id="flow13" name="Rejected" sourceRef="stage3Gateway" targetRef="endEventRejected">
            <conditionExpression xsi:type="tFormalExpression">
                ${stage3Decision == 'REJECT'}
            </conditionExpression>
        </sequenceFlow>
        
        <!-- End Events -->
        <endEvent id="endEventApproved" name="All Stages Approved"/>
        <endEvent id="endEventRejected" name="Rejected"/>
        
    </process>
    
    <!-- BPMN DI (Diagram Interchange) -->
    <bpmndi:BPMNDiagram id="BPMNDiagram_threeStageProcess">
        <bpmndi:BPMNPlane id="BPMNPlane_threeStageProcess" bpmnElement="threeStageProcess">
            
            <!-- Start Event -->
            <bpmndi:BPMNShape id="shape_startEvent" bpmnElement="startEvent">
                <omgdc:Bounds x="100" y="200" width="36" height="36"/>
            </bpmndi:BPMNShape>
            
            <!-- Stage 1: Products -->
            <bpmndi:BPMNShape id="shape_stage1MakerTask" bpmnElement="stage1MakerTask">
                <omgdc:Bounds x="200" y="178" width="100" height="80"/>
            </bpmndi:BPMNShape>
            <bpmndi:BPMNShape id="shape_stage1CheckerTask" bpmnElement="stage1CheckerTask">
                <omgdc:Bounds x="360" y="178" width="100" height="80"/>
            </bpmndi:BPMNShape>
            <bpmndi:BPMNShape id="shape_stage1Gateway" bpmnElement="stage1Gateway">
                <omgdc:Bounds x="520" y="193" width="50" height="50"/>
            </bpmndi:BPMNShape>
            
            <!-- Stage 2: Plans -->
            <bpmndi:BPMNShape id="shape_stage2MakerTask" bpmnElement="stage2MakerTask">
                <omgdc:Bounds x="640" y="178" width="100" height="80"/>
            </bpmndi:BPMNShape>
            <bpmndi:BPMNShape id="shape_stage2CheckerTask" bpmnElement="stage2CheckerTask">
                <omgdc:Bounds x="800" y="178" width="100" height="80"/>
            </bpmndi:BPMNShape>
            <bpmndi:BPMNShape id="shape_stage2Gateway" bpmnElement="stage2Gateway">
                <omgdc:Bounds x="960" y="193" width="50" height="50"/>
            </bpmndi:BPMNShape>
            
            <!-- Stage 3: Items -->
            <bpmndi:BPMNShape id="shape_stage3MakerTask" bpmnElement="stage3MakerTask">
                <omgdc:Bounds x="1080" y="178" width="100" height="80"/>
            </bpmndi:BPMNShape>
            <bpmndi:BPMNShape id="shape_stage3CheckerTask" bpmnElement="stage3CheckerTask">
                <omgdc:Bounds x="1240" y="178" width="100" height="80"/>
            </bpmndi:BPMNShape>
            <bpmndi:BPMNShape id="shape_stage3Gateway" bpmnElement="stage3Gateway">
                <omgdc:Bounds x="1400" y="193" width="50" height="50"/>
            </bpmndi:BPMNShape>
            
            <!-- End Events -->
            <bpmndi:BPMNShape id="shape_endEventApproved" bpmnElement="endEventApproved">
                <omgdc:Bounds x="1520" y="200" width="36" height="36"/>
            </bpmndi:BPMNShape>
            <bpmndi:BPMNShape id="shape_endEventRejected" bpmnElement="endEventRejected">
                <omgdc:Bounds x="527" y="320" width="36" height="36"/>
            </bpmndi:BPMNShape>
            
            <!-- Edges -->
            <bpmndi:BPMNEdge id="edge_flow1" bpmnElement="flow1">
                <omgdi:waypoint x="136" y="218"/>
                <omgdi:waypoint x="200" y="218"/>
            </bpmndi:BPMNEdge>
            <bpmndi:BPMNEdge id="edge_flow2" bpmnElement="flow2">
                <omgdi:waypoint x="300" y="218"/>
                <omgdi:waypoint x="360" y="218"/>
            </bpmndi:BPMNEdge>
            <bpmndi:BPMNEdge id="edge_flow3" bpmnElement="flow3">
                <omgdi:waypoint x="460" y="218"/>
                <omgdi:waypoint x="520" y="218"/>
            </bpmndi:BPMNEdge>
            <bpmndi:BPMNEdge id="edge_flow4" bpmnElement="flow4">
                <omgdi:waypoint x="570" y="218"/>
                <omgdi:waypoint x="640" y="218"/>
            </bpmndi:BPMNEdge>
            <bpmndi:BPMNEdge id="edge_flow5" bpmnElement="flow5">
                <omgdi:waypoint x="545" y="243"/>
                <omgdi:waypoint x="545" y="320"/>
            </bpmndi:BPMNEdge>
            <bpmndi:BPMNEdge id="edge_flow6" bpmnElement="flow6">
                <omgdi:waypoint x="740" y="218"/>
                <omgdi:waypoint x="800" y="218"/>
            </bpmndi:BPMNEdge>
            <bpmndi:BPMNEdge id="edge_flow7" bpmnElement="flow7">
                <omgdi:waypoint x="900" y="218"/>
                <omgdi:waypoint x="960" y="218"/>
            </bpmndi:BPMNEdge>
            <bpmndi:BPMNEdge id="edge_flow8" bpmnElement="flow8">
                <omgdi:waypoint x="1010" y="218"/>
                <omgdi:waypoint x="1080" y="218"/>
            </bpmndi:BPMNEdge>
            <bpmndi:BPMNEdge id="edge_flow9" bpmnElement="flow9">
                <omgdi:waypoint x="985" y="243"/>
                <omgdi:waypoint x="985" y="338"/>
                <omgdi:waypoint x="563" y="338"/>
            </bpmndi:BPMNEdge>
            <bpmndi:BPMNEdge id="edge_flow10" bpmnElement="flow10">
                <omgdi:waypoint x="1180" y="218"/>
                <omgdi:waypoint x="1240" y="218"/>
            </bpmndi:BPMNEdge>
            <bpmndi:BPMNEdge id="edge_flow11" bpmnElement="flow11">
                <omgdi:waypoint x="1340" y="218"/>
                <omgdi:waypoint x="1400" y="218"/>
            </bpmndi:BPMNEdge>
            <bpmndi:BPMNEdge id="edge_flow12" bpmnElement="flow12">
                <omgdi:waypoint x="1450" y="218"/>
                <omgdi:waypoint x="1520" y="218"/>
            </bpmndi:BPMNEdge>
            <bpmndi:BPMNEdge id="edge_flow13" bpmnElement="flow13">
                <omgdi:waypoint x="1425" y="243"/>
                <omgdi:waypoint x="1425" y="338"/>
                <omgdi:waypoint x="563" y="338"/>
            </bpmndi:BPMNEdge>
            
        </bpmndi:BPMNPlane>
    </bpmndi:BPMNDiagram>
    
</definitions>

